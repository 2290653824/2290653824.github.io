(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{434:function(s,t,e){"use strict";e.r(t);var a=e(4),n=Object(a.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h3",{attrs:{id:"redis-hotkey-热-key"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#redis-hotkey-热-key"}},[s._v("#")]),s._v(" Redis hotkey（热 Key）")]),s._v(" "),t("h4",{attrs:{id:"什么是-hotkey"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#什么是-hotkey"}},[s._v("#")]),s._v(" 什么是 hotkey？")]),s._v(" "),t("p",[s._v("简单来说，如果一个 key 的访问次数比较多且明显多于其他 key 的话，那这个 key 就可以看作是 hotkey。例如在 Redis 实例的每秒处理请求达到 5000 次，而其中某个 key 的每秒访问量就高达 2000 次，那这个 key 就可以看作是 hotkey。")]),s._v(" "),t("p",[s._v("hotkey 出现的原因主要是某个热点数据访问量暴增，如重大的热搜事件、参与秒杀的商品。")]),s._v(" "),t("h4",{attrs:{id:"hotkey-有什么危害"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#hotkey-有什么危害"}},[s._v("#")]),s._v(" hotkey 有什么危害？")]),s._v(" "),t("p",[s._v("处理 hotkey 会占用大量的 CPU 和带宽，可能会影响 Redis 实例对其他请求的正常处理。此外，如果突然访问 hotkey 的请求超出了 Redis 的处理能力，Redis 就会直接宕机。这种情况下，大量请求将落到后面的数据库上，可能会导致数据库崩溃。")]),s._v(" "),t("p",[s._v("因此，hotkey 很可能成为系统性能的瓶颈点，需要单独对其进行优化，以确保系统的高可用性和稳定性。")]),s._v(" "),t("h4",{attrs:{id:"如何发现-hotkey"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何发现-hotkey"}},[s._v("#")]),s._v(" 如何发现 hotkey？")]),s._v(" "),t("p",[t("strong",[s._v("1、使用 Redis 自带的 "),t("code",[s._v("--hotkeys")]),s._v(" 参数来查找。")])]),s._v(" "),t("p",[s._v("Redis 4.0.3 版本中新增了 "),t("code",[s._v("hotkeys")]),s._v(" 参数，该参数能够返回所有 key 的被访问次数。")]),s._v(" "),t("p",[s._v("使用该方案的前提条件是 Redis Server 的 "),t("code",[s._v("maxmemory-policy")]),s._v(" 参数设置为 LFU 算法，不然就会出现如下所示的错误。")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# redis-cli -p 6379 --hotkeys")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Scanning the entire keyspace to find hot keys as well as")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# average sizes per key type.  You can use -i 0.1 to sleep 0.1 sec")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# per 100 SCAN commands (not usually needed).")]),s._v("\n\nError: ERR An LFU maxmemory policy is not selected, access frequency not tracked. Please note that when switching between policies at runtime LRU and LFU data will take some "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("time")]),s._v(" to adjust.\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br")])]),t("p",[s._v("Redis 中有两种 LFU 算法：")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("volatile-lfu（least frequently used）")]),s._v("：从已设置过期时间的数据集（"),t("code",[s._v("server.db[i].expires")]),s._v("）中挑选最不经常使用的数据淘汰。")]),s._v(" "),t("li",[t("strong",[s._v("allkeys-lfu（least frequently used）")]),s._v("：当内存不足以容纳新写入数据时，在键空间中，移除最不经常使用的 key。")])]),s._v(" "),t("p",[s._v("以下是配置文件 "),t("code",[s._v("redis.conf")]),s._v(" 中的示例：")]),s._v(" "),t("div",{staticClass:"language-properties line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-properties"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 使用 volatile-lfu 策略")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("maxmemory-policy")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("volatile-lfu")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 或者使用 allkeys-lfu 策略")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("maxmemory-policy")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("allkeys-lfu")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("p",[s._v("需要注意的是，"),t("code",[s._v("hotkeys")]),s._v(" 参数命令也会增加 Redis 实例的 CPU 和内存消耗（全局扫描），因此需要谨慎使用。")]),s._v(" "),t("p",[t("strong",[s._v("2、使用"),t("code",[s._v("MONITOR")]),s._v(" 命令。")])]),s._v(" "),t("p",[t("code",[s._v("MONITOR")]),s._v(" 命令是 Redis 提供的一种实时查看 Redis 的所有操作的方式，可以用于临时监控 Redis 实例的操作情况，包括读写、删除等操作。")]),s._v(" "),t("p",[s._v("由于该命令对 Redis 性能的影响比较大，因此禁止长时间开启 "),t("code",[s._v("MONITOR")]),s._v("（生产环境中建议谨慎使用该命令）。")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[s._v("# redis"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("cli\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("127.0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6379")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("MONITOR")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("OK")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638260.637378")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61516")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ping"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638267.144236")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638268.941863")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638269.551671")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638270.646256")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61516")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"ping"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638270.849551")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638271.926945")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638274.276599")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet2"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1683638276.327234")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("172.17")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".0")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v(".1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61518")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"smembers"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"mySet"')]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("在发生紧急情况时，我们可以选择在合适的时机短暂执行 "),t("code",[s._v("MONITOR")]),s._v(" 命令并将输出重定向至文件，在关闭 "),t("code",[s._v("MONITOR")]),s._v(" 命令后通过对文件中请求进行归类分析即可找出这段时间中的 hotkey。")]),s._v(" "),t("p",[t("strong",[s._v("3、借助开源项目。")])]),s._v(" "),t("p",[s._v("京东零售的 "),t("a",{attrs:{href:"https://gitee.com/jd-platform-opensource/hotkey",target:"_blank",rel:"noopener noreferrer"}},[s._v("hotkeyopen in new window"),t("OutboundLink")],1),s._v(" 这个项目不光支持 hotkey 的发现，还支持 hotkey 的处理。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230623183232017.png",alt:"image-20230623183232017"}}),s._v("京东零售开源的 hotkey")]),s._v(" "),t("p",[t("strong",[s._v("4、根据业务情况提前预估。")])]),s._v(" "),t("p",[s._v("可以根据业务情况来预估一些 hotkey，比如参与秒杀活动的商品数据等。不过，我们无法预估所有 hotkey 的出现，比如突发的热点新闻事件等。")]),s._v(" "),t("p",[t("strong",[s._v("5、业务代码中记录分析。")])]),s._v(" "),t("p",[s._v("在业务代码中添加相应的逻辑对 key 的访问情况进行记录分析。不过，这种方式会让业务代码的复杂性增加，一般也不会采用。")]),s._v(" "),t("p",[t("strong",[s._v("6、借助公有云的 Redis 分析服务。")])]),s._v(" "),t("p",[s._v("如果你用的是公有云的 Redis 服务的话，可以看看其是否提供了 key 分析功能（一般都提供了）。")]),s._v(" "),t("p",[s._v("这里以阿里云 Redis 为例说明，它支持 hotkey 实时分析、发现，文档地址："),t("a",{attrs:{href:"https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-feature",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.alibabacloud.com/help/zh/apsaradb-for-redis/latest/use-the-real-time-key-statistics-featureopen in new window"),t("OutboundLink")],1),s._v(" 。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230623183240548.png",alt:"image-20230623183240548"}}),s._v("阿里云Key分析")]),s._v(" "),t("h4",{attrs:{id:"如何解决-hotkey"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#如何解决-hotkey"}},[s._v("#")]),s._v(" 如何解决 hotkey？")]),s._v(" "),t("p",[s._v("hotkey 的常见处理以及优化办法如下（这些方法可以配合起来使用）：")]),s._v(" "),t("ul",[t("li",[t("strong",[s._v("读写分离")]),s._v("：主节点处理写请求，从节点处理读请求。")]),s._v(" "),t("li",[t("strong",[s._v("使用 Redis Cluster")]),s._v("：将热点数据分散存储在多个 Redis 节点上。")]),s._v(" "),t("li",[t("strong",[s._v("二级缓存")]),s._v("：hotkey 采用二级缓存的方式进行处理，将 hotkey 存放一份到 JVM 本地内存中（可以用 Caffeine）。")])]),s._v(" "),t("p",[s._v("除了这些方法之外，如果你使用的公有云的 Redis 服务话，还可以留意其提供的开箱即用的解决方案。")]),s._v(" "),t("p",[s._v("这里以阿里云 Redis 为例说明，它支持通过代理查询缓存功能（Proxy Query Cache）优化热点 Key 问题。")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/image-20230623183251037.png",alt:"image-20230623183251037"}}),s._v("通过阿里云的Proxy Query Cache优化热点Key问题")])])}),[],!1,null,null,null);t.default=n.exports}}]);