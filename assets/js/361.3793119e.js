(window.webpackJsonp=window.webpackJsonp||[]).push([[361],{685:function(s,e,n){"use strict";n.r(e);var a=n(4),t=Object(a.a)({},(function(){var s=this,e=s._self._c;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h1",{attrs:{id:"kubevirt创建虚拟机问题记录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#kubevirt创建虚拟机问题记录"}},[s._v("#")]),s._v(" "),e("strong",[s._v("kubevirt创建虚拟机问题记录")])]),s._v(" "),e("h2",{attrs:{id:"环境"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#环境"}},[s._v("#")]),s._v(" "),e("strong",[s._v("环境")])]),s._v(" "),e("p",[s._v("Ubuntu 20.04.6 LTS")]),s._v(" "),e("p",[s._v("k8s 1.28.0 【1个master，2个node】")]),s._v(" "),e("p",[s._v("kubevirt 0.57.0")]),s._v(" "),e("h2",{attrs:{id:"问题复现"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题复现"}},[s._v("#")]),s._v(" "),e("strong",[s._v("问题复现")])]),s._v(" "),e("p",[s._v("​            1.     在k8s集群上通过以下命令安装kubevirt")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl create -f https://github.com/kubevirt/kubevirt/releases/download/v1.0.0/kubevirt-operator.yaml\n\nkubectl create -f https://github.com/kubevirt/kubevirt/releases/download/v1.0.0/kubevirt-cr.yaml\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("​            2.     安装virtctl")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("wget https://github.com/kubevirt/kubevirt/releases/download/v0.57.0/virtctl-v0.57.0-linux-amd64 -O virtctl\n\nchmod +x virtctl\nsudo install virtctl /usr/local/bin\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[s._v("上述安装完成后相应的pod")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230182.png",alt:"img"}})]),s._v(" "),e("p",[s._v("​            3.     创建虚拟机")]),s._v(" "),e("p",[s._v("vm.yaml文件（来自官网: https://kubevirt.io/labs/manifests/vm.yaml)")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("apiVersion: kubevirt.io/v1\nkind: VirtualMachine\nmetadata:\n  name: testvm\nspec:\n  running: false\n  template:\n    metadata:\n      labels:\n        kubevirt.io/size: small\n        kubevirt.io/domain: testvm\n    spec:\n      domain:\n        devices:\n          disks:\n            - name: containerdisk\n              disk:\n                bus: virtio\n            - name: cloudinitdisk\n              disk:\n                bus: virtio\n          interfaces:\n          - name: default\n            masquerade: {}\n        resources:\n          requests:\n            memory: 64M\n      networks:\n      - name: default\n        pod: {}\n      volumes:\n        - name: containerdisk\n          containerDisk:\n            image: quay.io/kubevirt/cirros-container-disk-demo\n        - name: cloudinitdisk\n          cloudInitNoCloud:\n            userDataBase64: SGkuXG4=\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br")])]),e("p",[s._v("创建vm: kubectl create -f ym.yaml")]),s._v(" "),e("p",[s._v("​            4.     查看vm状态")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230248.png",alt:"img"}})]),s._v(" "),e("p",[s._v("​            5.     启动vm: virtctl start test-vm")]),s._v(" "),e("p",[s._v("再次查看状态")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230276.png",alt:"img"}})]),s._v(" "),e("p",[s._v("​            6.     查看描述信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v(" Message:               0/3 nodes are available: 3 node(s) didn't match Pod's node affinity/selector. preemption: 0/3 nodes are available: 3 Preemption is not helpful for scheduling..\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230350.png",alt:"img"}})]),s._v(" "),e("h2",{attrs:{id:""}},[e("a",{staticClass:"header-anchor",attrs:{href:"#"}},[s._v("#")])]),s._v(" "),e("h2",{attrs:{id:"-2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#-2"}},[s._v("#")])]),s._v(" "),e("h2",{attrs:{id:"问题1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题1"}},[s._v("#")]),s._v(" "),e("strong",[s._v("问题1")])]),s._v(" "),e("p",[s._v("这里虚拟机无法正常启动，上述红框中所示问题。我在网上查询了资料，但是也没有找到解决问题的方法，况哥之前有遇到过这种问题吗？")]),s._v(" "),e("p",[s._v("==========================排查过程=========================")]),s._v(" "),e("p",[s._v("自己补充了点关于k8s污点、容忍、亲和力相关的知识点。知道了这个报错可能是因为对应的pod通过nodeSelector或者污点导致找不到对应的node进行调度。")]),s._v(" "),e("p",[s._v("​            1.     找到虚拟机对应的pod，进行describe描述")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230404.png",alt:"img"}})]),s._v(" "),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230431.png",alt:"img"}})]),s._v(" "),e("p",[s._v("这里声明了节点选择器,必须有节点满足"),e("a",{attrs:{href:"http://kubevirt.io/schedulable=true",target:"_blank",rel:"noopener noreferrer"}},[s._v("kubevirt.io/schedulable=true"),e("OutboundLink")],1),s._v(" 才能进行调度")]),s._v(" "),e("p",[s._v("然后我们通过以下命令查看节点的lebal")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('kubectl  get  node openstacktest-1 --show-labels | grep "kubevirt.io/schedulable"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[e("img",{attrs:{src:"https://2290653824-github-io.oss-cn-hangzhou.aliyuncs.com/png-20230915152230460.png",alt:"img"}})]),s._v(" "),e("p",[s._v("预期：我们把这个标签改为true，那么对应的vm节点的nodeSelector可以正常调度到对应的节点")]),s._v(" "),e("p",[s._v("我们使用label命令进行改变")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl label node openstacktest-1 kubevirt.io/schedulable=true --overwrite\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("命令指令后，我们通过查看标签没有问题")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('kubectl  get  node openstacktest-1 --show-labels | grep "kubevirt.io/schedulable"\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br")])]),e("p",[s._v("但是我们隔一分钟过后，再看标签，发现标签又变回了false")]),s._v(" "),e("h2",{attrs:{id:"问题2"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#问题2"}},[s._v("#")]),s._v(" "),e("strong",[s._v("问题2")])]),s._v(" "),e("p",[s._v("是什么原因导致我使用label命令更改node的label为"),e("a",{attrs:{href:"http://kubevirt.io/schedulable=true",target:"_blank",rel:"noopener noreferrer"}},[s._v("kubevirt.io/schedulable=true"),e("OutboundLink")],1),s._v("，过一段时间后，对应label变为了"),e("a",{attrs:{href:"http://kubevirt.io/schedulable=false",target:"_blank",rel:"noopener noreferrer"}},[s._v("kubevirt.io/schedulable=false"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("根本原因是virt-handler对node节点的label进行了更改")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://kubevirt.io/user-guide/operations/annotations_and_labels/#kubevirtioschedulable",target:"_blank",rel:"noopener noreferrer"}},[s._v("Annotations and labels - KubeVirt user guide"),e("OutboundLink")],1)]),s._v(" "),e("p",[e("a",{attrs:{href:"https://kubevirt.io/user-guide/operations/unresponsive_nodes/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Unresponsive nodes - KubeVirt user guide"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("更新于：2023.9.12")]),s._v(" "),e("p",[s._v("什么是嵌套虚拟化？：")]),s._v(" "),e("p",[s._v("嵌套虚拟化是指在虚拟机中运行另一个虚拟机的技术。它允许在一台物理机器上运行多个虚拟机，每个虚拟机都可以运行自己的操作系统。这种技术可以用于在生产环境中测试新的操作系统和软件，或者在教育和研究环境中模拟复杂的网络环境。嵌套虚拟化需要在物理机器上安装虚拟化软件，并在虚拟机中启用虚拟化支持。")]),s._v(" "),e("p",[s._v("解决方法：")]),s._v(" "),e("p",[e("strong",[s._v("重新安装了k8s 1.28和网络组件，并使用的kubeVirt版本为v1.0.0")])]),s._v(" "),e("p",[s._v("过程中需要开启嵌套虚拟化功能[如果虚拟化不可用，则需要手动开启软件仿真（虚拟机必须开）]")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("kubectl create   configmap kubevirt-config -n kubevirt --from-literal=debug.useEmulation=true --from-literal=feature-gates=Macvtap,LiveMigration,Snapshot\n# LiveMigration 开启迁移功能\n# Snapshot 开启快照功能\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("k8s集群搭建这里不做介绍，主要看看kubevirt安装过程")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://juejin.cn/post/7092334473525592078",target:"_blank",rel:"noopener noreferrer"}},[s._v("kubevirt安装与基本使用 - 掘金"),e("OutboundLink")],1)]),s._v(" "),e("p",[s._v("按照上述创建并启动虚拟机后，可以通过virtctl console命令连接到对应的虚拟机")]),s._v(" "),e("p",[s._v("虚拟机默认用户和密码：")]),s._v(" "),e("p",[s._v("user: "),e("code",[s._v("cirros")])]),s._v(" "),e("p",[s._v("password: "),e("code",[s._v("gocubsgo")])]),s._v(" "),e("h2",{attrs:{id:"附录"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#附录"}},[s._v("#")]),s._v(" "),e("strong",[s._v("附录")])]),s._v(" "),e("p",[s._v("完整描述信息")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("root@openstackTest-1:~/kubevirt# kubectl describe vm test-vm\nName:         test-vm\nNamespace:    default\nLabels:       <none>\nAnnotations:  kubevirt.io/latest-observed-api-version: v1\n              kubevirt.io/storage-observed-api-version: v1alpha3\nAPI Version:  kubevirt.io/v1\nKind:         VirtualMachine\nMetadata:\n  Creation Timestamp:  2023-09-05T02:30:06Z\n  Generation:          2\n  Resource Version:    518769\n  UID:                 1e119181-78cc-4e0b-9ea7-b1688c94e7c0\nSpec:\n  Running:  true\n  Template:\n    Metadata:\n      Creation Timestamp:  <nil>\n      Labels:\n        kubevirt.io/domain:  testvm\n        kubevirt.io/size:    small\n    Spec:\n      Domain:\n        Devices:\n          Disks:\n            Disk:\n              Bus:  virtio\n            Name:   containerdisk\n          Interfaces:\n            Masquerade:\n            Name:  default\n        Machine:\n          Type:  q35\n        Resources:\n          Requests:\n            Memory:  64M\n      Networks:\n        Name:  default\n        Pod:\n      Node Selector:\n        Role:  worker\n      Volumes:\n        Container Disk:\n          Image:  quay.io/kubevirt/cirros-container-disk-demo\n        Name:     containerdisk\nStatus:\n  Conditions:\n    Last Probe Time:       2023-09-05T02:31:05Z\n    Last Transition Time:  2023-09-05T02:31:05Z\n    Message:               Guest VM is not reported as running\n    Reason:                GuestNotRunning\n    Status:                False\n    Type:                  Ready\n    Last Probe Time:       <nil>\n    Last Transition Time:  2023-09-05T02:31:05Z\n    Message:               0/3 nodes are available: 3 node(s) didn't match Pod's node affinity/selector. preemption: 0/3 nodes are available: 3 Preemption is not helpful for scheduling..\n    Reason:                Unschedulable\n    Status:                False\n    Type:                  PodScheduled\n  Created:                 true\n  Printable Status:        ErrorUnschedulable\n  Volume Snapshot Statuses:\n    Enabled:  false\n    Name:     containerdisk\n    Reason:   Snapshot is not supported for this volumeSource type [containerdisk]\nEvents:\n  Type    Reason            Age   From                       Message\n  ----    ------            ----  ----                       -------\n  Normal  SuccessfulCreate  51s   virtualmachine-controller  Started the virtual machine by creating the new virtual machine instance test-vm\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br"),e("span",{staticClass:"line-number"},[s._v("51")]),e("br"),e("span",{staticClass:"line-number"},[s._v("52")]),e("br"),e("span",{staticClass:"line-number"},[s._v("53")]),e("br"),e("span",{staticClass:"line-number"},[s._v("54")]),e("br"),e("span",{staticClass:"line-number"},[s._v("55")]),e("br"),e("span",{staticClass:"line-number"},[s._v("56")]),e("br"),e("span",{staticClass:"line-number"},[s._v("57")]),e("br"),e("span",{staticClass:"line-number"},[s._v("58")]),e("br"),e("span",{staticClass:"line-number"},[s._v("59")]),e("br"),e("span",{staticClass:"line-number"},[s._v("60")]),e("br"),e("span",{staticClass:"line-number"},[s._v("61")]),e("br"),e("span",{staticClass:"line-number"},[s._v("62")]),e("br"),e("span",{staticClass:"line-number"},[s._v("63")]),e("br"),e("span",{staticClass:"line-number"},[s._v("64")]),e("br"),e("span",{staticClass:"line-number"},[s._v("65")]),e("br"),e("span",{staticClass:"line-number"},[s._v("66")]),e("br"),e("span",{staticClass:"line-number"},[s._v("67")]),e("br"),e("span",{staticClass:"line-number"},[s._v("68")]),e("br"),e("span",{staticClass:"line-number"},[s._v("69")]),e("br")])])])}),[],!1,null,null,null);e.default=t.exports}}]);