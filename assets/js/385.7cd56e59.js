(window.webpackJsonp=window.webpackJsonp||[]).push([[385],{708:function(s,t,a){"use strict";a.r(t);var n=a(4),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("介绍\n什么是JMH")]),s._v(" "),t("p",[s._v("JMH和jMeter的使用场景还是有很大的不同的，jMeter更多的是对rest api进行压测，而JMH关注的粒度更细，它更多的是发现某块性能槽点代码，然后对优化方案进行基准测试对比。比如json序列化方案对比，bean copy方案对比，文中提高的洗牌算法对比等。")]),s._v(" "),t("p",[s._v("JMH（Java Microbenchmark Harness）是一个专门用于编写和运行 Java 微基准测试的框架。")]),s._v(" "),t("p",[s._v("一般使用流程如下")]),s._v(" "),t("p",[s._v("下面简单介绍一下如何使用 JMH 进行基准测试：")]),s._v(" "),t("ol",[t("li",[s._v("添加依赖：在项目中添加 JMH 的依赖，可以通过 Maven 或 Gradle 等构建工具配置。")])]),s._v(" "),t("div",{staticClass:"language-xml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-xml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.openjdk.jmh"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("jmh-core"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1.33"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("org.openjdk.jmh"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("groupId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("jmh-generator-annprocess"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("artifactId")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("<")]),s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("1.33"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("version")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token tag"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("</")]),s._v("dependency")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(">")])]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br")])]),t("ol",[t("li",[s._v("编写基准测试代码：创建一个类，并在其中编写需要进行基准测试的方法。")]),s._v(" "),t("li",[s._v("使用 @Benchmark 注解标记需要进行基准测试的方法。")]),s._v(" "),t("li",[s._v("配置基准测试选项：可以使用 @State 注解来配置基准测试的状态，例如共享变量、线程数等。")])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("openjdk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jmh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotations"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Benchmark")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("openjdk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jmh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotations"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Scope")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("import")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token import"}},[t("span",{pre:!0,attrs:{class:"token namespace"}},[s._v("org"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("openjdk"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("jmh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("annotations"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")])]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("State")])]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@State")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Scope"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Thread")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MyBenchmark")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" y "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Benchmark")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" y"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Benchmark")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("subtract")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" x "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" y"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("ol",[t("li",[s._v("运行基准测试：可以使用命令行或者其他可视化工具来运行基准测试，例如使用 Maven 命令 "),t("code",[s._v("mvn clean install")]),s._v(" 或 "),t("code",[s._v("mvn clean install -DskipTests=false")])]),s._v(" "),t("li",[s._v("分析结果：JMH 会输出详细的测试结果，包括每个测试方法的平均时间、吞吐量、方差、标准差等统计数据，可以根据这些数据来分析和比较基准测试的结果。")])]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Benchmark")]),s._v("              "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Mode")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Cnt")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Score")]),s._v("   "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Error")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Units")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MyBenchmark")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("add       thrpt   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.313")]),s._v(" ± "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.076")]),s._v("  ops"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("s\n"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("MyBenchmark")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("subtract  thrpt   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),s._v("  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.304")]),s._v(" ± "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.076")]),s._v("  ops"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v("s\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("解释一下，这里是测的是吞吐量，那么score表示就是每秒执行了 16 次。后面的error表示的是误差。cnt表示迭代次数。")]),s._v(" "),t("p",[s._v("JMH的使用")]),s._v(" "),t("ol",[t("li",[s._v("@BenchmarkMode")])]),s._v(" "),t("p",[s._v("用来配置 Mode 选项，可用于类或者方法上，这个注解的 value 是一个数组，可以把几种 Mode 集合在一起执行，如："),t("code",[s._v("@BenchmarkMode({Mode.SampleTime, Mode.AverageTime})")]),s._v("，还可以设置为 "),t("code",[s._v("Mode.All")]),s._v("，即全部执行一遍。")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("Throughput：整体吞吐量，每秒执行了多少次调用，单位为 "),t("code",[s._v("ops/time")])])]),s._v(" "),t("li",[t("p",[s._v("AverageTime：用的平均时间，每次操作的平均时间，单位为 "),t("code",[s._v("time/op")])])]),s._v(" "),t("li",[t("p",[s._v("SampleTime：随机取样，最后输出取样结果的分布")])]),s._v(" "),t("li",[t("p",[s._v("SingleShotTime：只运行一次，往往同时把 Warmup 次数设为 0，用于测试冷启动时的性能")])]),s._v(" "),t("li",[t("p",[s._v("All：上面的所有模式都执行一次")])]),s._v(" "),t("li",[t("p",[s._v("@State")])])]),s._v(" "),t("p",[s._v("通过 State 可以指定一个对象的作用范围，JMH 根据 scope 来进行实例化和共享操作。@State 可以被继承使用，如果父类定义了该注解，子类则无需定义。由于 JMH 允许多线程同时执行测试，不同的选项含义如下：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("Scope.Benchmark：所有测试线程共享一个实例，测试有状态实例在多线程共享下的性能")])]),s._v(" "),t("li",[t("p",[s._v("Scope.Group：同一个线程在同一个 group 里共享实例")])]),s._v(" "),t("li",[t("p",[s._v("Scope.Thread：默认的 State，每个测试线程分配一个实例")])]),s._v(" "),t("li",[t("p",[s._v("@OutputTimeUnit")])])]),s._v(" "),t("p",[s._v("为统计结果的时间单位，可用于类或者方法注解")]),s._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[s._v("@Warmup")])]),s._v(" "),t("p",[s._v("预热所需要配置的一些基本测试参数，可用于类或者方法上。一般前几次进行程序测试的时候都会比较慢，所以要让程序进行几轮预热，保证测试的准确性。参数如下所示：")]),s._v(" "),t("ol",[t("li",[s._v("iterations：预热的次数")]),s._v(" "),t("li",[s._v("time：每次预热的时间")]),s._v(" "),t("li",[s._v("timeUnit：时间的单位，默认秒")]),s._v(" "),t("li",[s._v("batchSize：批处理大小，每次操作调用几次方法")])]),s._v(" "),t("blockquote",[t("p",[t("strong",[s._v("为什么需要预热？")]),s._v("\n因为 JVM 的 JIT 机制的存在，如果某个函数被调用多次之后，JVM 会尝试将其编译为机器码，从而提高执行速度，所以为了让 benchmark 的结果更加接近真实情况就需要进行预热。")])]),s._v(" "),t("ol",{attrs:{start:"5"}},[t("li",[s._v("@Measurement")])]),s._v(" "),t("p",[s._v("实际调用方法所需要配置的一些基本测试参数，可用于类或者方法上，参数和 "),t("code",[s._v("@Warmup")]),s._v(" 相同。")]),s._v(" "),t("ol",{attrs:{start:"6"}},[t("li",[s._v("@Threads")])]),s._v(" "),t("p",[s._v("每个进程中的测试线程，可用于类或者方法上。")]),s._v(" "),t("ol",{attrs:{start:"7"}},[t("li",[s._v("@Fork")])]),s._v(" "),t("p",[s._v("进行 fork 的次数，可用于类或者方法上。如果 fork 数是 2 的话，则 JMH 会 fork 出两个进程来进行测试。")]),s._v(" "),t("ol",{attrs:{start:"8"}},[t("li",[s._v("@Param")])]),s._v(" "),t("p",[s._v("指定某项参数的多种情况，特别适合用来测试一个函数在不同的参数输入的情况下的性能，只能作用在字段上，使用该注解必须定义 @State 注解。")]),s._v(" "),t("p",[s._v("在介绍完常用的注解后，让我们来看下 JMH 有哪些陷阱。")]),s._v(" "),t("p",[s._v("可参考文档：")]),s._v(" "),t("p",[s._v("https://www.cnblogs.com/54chensongxia/p/15485421.html")])])}),[],!1,null,null,null);t.default=e.exports}}]);